<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Miss Han - A Gift from Mr Meng</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: radial-gradient(circle at center, #0a0a14 0%, #000 100%); font-family: 'Segoe UI', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; }
        
        .header {
            position: absolute;
            top: 40px;
            width: 100%;
            text-align: center;
            z-index: 100;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-family: 'Dancing Script', cursive;
            font-size: 4.5rem;
            margin: 0;
            background: linear-gradient(to bottom, #fffef0 0%, #ffd700 40%, #ff8c00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 8px rgba(0,0,0,0.8));
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .signature {
            font-family: 'Dancing Script', cursive;
            font-size: 1.6rem;
            color: #ffd700;
            margin-top: 5px;
            transform: translateX(180px);
            opacity: 0.9;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }

        video { 
            transform: scaleX(-1); 
            position: absolute; 
            bottom: 20px; 
            right: 20px; 
            width: 180px; 
            height: 135px;
            border: 1.5px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px; 
            object-fit: cover;
            opacity: 0.5;
        }

        .status-dot {
            position: absolute;
            bottom: 165px;
            right: 30px;
            color: rgba(255,255,255,0.6);
            font-size: 0.7rem;
        }
    </style>
</head>
<body onclick="startAudio()">

<div class="header">
    <h1>Miss Han, Merry Christmas!</h1>
    <div class="signature">from Mr Meng</div>
</div>

<div id="status" class="status-dot">TAP TO START MAGIC...</div>
<div id="canvas-container"></div>
<video id="video" autoplay playsinline></video>

<audio id="bgm" loop>
    <source src="music.mp3" type="audio/mpeg">
</audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/** -----------------------------------------------------------------
 * 1. 音乐控制逻辑
 * ----------------------------------------------------------------- */
const audio = document.getElementById('bgm');
let audioStarted = false;

function startAudio() {
    if (!audioStarted) {
        audio.play().catch(e => console.log("Audio play failed", e));
        audioStarted = true;
        document.getElementById('status').innerText = "MAGIC ACTIVE";
    }
}

/** -----------------------------------------------------------------
 * 2. 3D 视觉引擎
 * ----------------------------------------------------------------- */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(0, 3, 28); 
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
document.getElementById('canvas-container').appendChild(renderer.domElement);

const particleCount = 20000; 
const geometry = new THREE.BufferGeometry();
const posArray = new Float32Array(particleCount * 3);
const treePositions = new Float32Array(particleCount * 3);
const starPositions = new Float32Array(particleCount * 3);
const colors = new Float32Array(particleCount * 3);

const endTreeBody = Math.floor(particleCount * 0.60);
const endTrunk = Math.floor(particleCount * 0.70);
const endTopBall = Math.floor(particleCount * 0.73);
const endRibbon = Math.floor(particleCount * 0.88);

for (let i = 0; i < particleCount; i++) {
    const i3 = i * 3;
    starPositions[i3] = (Math.random() - 0.5) * 75;
    starPositions[i3+1] = (Math.random() - 0.5) * 65;
    starPositions[i3+2] = (Math.random() - 0.5) * 55;

    let r, g, b, x, y, z;
    if (i < endTreeBody) {
        const ratio = i / endTreeBody;
        const h = 16 * ratio;
        const rad = (16 - h) * 0.4;
        const ang = 0.6 * i;
        x = Math.cos(ang) * rad + (Math.random()-0.5)*0.5;
        y = h - 9.5;
        z = Math.sin(ang) * rad + (Math.random()-0.5)*0.5;
        const cr = Math.random();
        if (cr < 0.4) { r=1; g=0.85; b=0.2; } 
        else if (cr < 0.7) { r=0.1; g=0.7; b=0.3; } 
        else { r=1; g=0.3; b=0.7; }
    } else if (i < endTrunk) {
        x = Math.cos(Math.random()*7) * 0.8 * Math.random();
        y = ((i - endTreeBody) / (endTrunk - endTreeBody) * 4.5) - 14;
        z = Math.sin(Math.random()*7) * 0.8 * Math.random();
        r=0.4; g=0.2; b=0.05;
    } else if (i < endTopBall) {
        const ratio = (i - endTrunk) / (endTopBall - endTrunk);
        const phi = Math.acos(-1 + (2 * ratio));
        const theta = Math.sqrt(particleCount * Math.PI) * phi;
        x = 1.3 * Math.cos(theta) * Math.sin(phi);
        y = 1.3 * Math.sin(theta) * Math.sin(phi) + 7.5; 
        z = 1.3 * Math.cos(phi);
        r=1.0; g=1.0; b=0.7; 
    } else if (i < endRibbon) {
        const ratio = (i - endTopBall) / (endRibbon - endTopBall);
        const h = 16 * (1 - ratio);
        const rad = (16 - h) * 0.43 + 0.6; 
        const ang = h * 2.2; 
        x = Math.cos(ang) * rad;
        y = h - 9.5;
        z = Math.sin(ang) * rad;
        r=1.0; g=0.9; b=0.3; 
    } else {
        const ratio = (i - endRibbon) / (particleCount - endRibbon);
        const h = 15.5 * (1 - ratio);
        const rad = (16 - h) * 0.46 + 0.9;
        const ang = h * 2.2 + (Math.random()-0.5)*0.6;
        x = Math.cos(ang) * rad;
        y = h - 9.5 + (Math.random()-0.5)*0.6;
        z = Math.sin(ang) * rad;
        const cr = Math.random();
        if(cr<0.35){r=1;g=0.2;b=0.2;} 
        else if(cr<0.7){r=0.2;g=0.5;b=1;} 
        else {r=0.9;g=0.2;b=0.9;}
    }
    treePositions[i3] = x; treePositions[i3+1] = y; treePositions[i3+2] = z;
    colors[i3] = r; colors[i3+1] = g; colors[i3+2] = b;
    posArray[i3] = starPositions[i3]; posArray[i3+1] = starPositions[i3+1]; posArray[i3+2] = starPositions[i3+2];
}

geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
const material = new THREE.PointsMaterial({ size: 0.13, vertexColors: true, transparent: true, opacity: 0.95, blending: THREE.AdditiveBlending, depthWrite: false });
const treeParticles = new THREE.Points(geometry, material);
scene.add(treeParticles);

/** -----------------------------------------------------------------
 * 3. 交互逻辑与 AI
 * ----------------------------------------------------------------- */
let isFist = false; 
let rotationSpeed = 0.002;

function onResults(results) {
    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        // 第一次检测到手时也尝试触发音乐（以防用户没点击屏幕）
        if (!audioStarted) startAudio();

        const hand = results.multiHandLandmarks[0];
        const palmCenter = hand[9];
        const fingerTips = [8, 12, 16, 20];
        let totalDist = 0;
        fingerTips.forEach(idx => {
            const tip = hand[idx];
            totalDist += Math.sqrt(Math.pow(tip.x - palmCenter.x, 2) + Math.pow(tip.y - palmCenter.y, 2));
        });
        isFist = (totalDist / 4) < 0.13;
        
        camera.position.x += ((hand[9].x - 0.5) * 12 - camera.position.x) * 0.05;
        camera.position.y += (-(hand[9].y - 0.5) * 8 + 3 - camera.position.y) * 0.05;
        camera.lookAt(0, 0, 0); 
    } else {
        isFist = false;
    }
}

const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
hands.onResults(onResults);

const cameraMP = new Camera(videoElement, {
    onFrame: async () => { await hands.send({image: videoElement}); },
    width: 640, height: 480
});
cameraMP.start();

function animate() {
    requestAnimationFrame(animate);
    const posAttr = geometry.attributes.position;
    const lerpSpeed = isFist ? 0.06 : 0.025; 
    for (let i = 0; i < particleCount; i++) {
        const i3 = i * 3;
        posAttr.array[i3] += ((isFist ? treePositions[i3] : starPositions[i3]) - posAttr.array[i3]) * lerpSpeed;
        posAttr.array[i3+1] += ((isFist ? treePositions[i3+1] : starPositions[i3+1]) - posAttr.array[i3+1]) * lerpSpeed;
        posAttr.array[i3+2] += ((isFist ? treePositions[i3+2] : starPositions[i3+2]) - posAttr.array[i3+2]) * lerpSpeed;
    }
    posAttr.needsUpdate = true;
    rotationSpeed += ((isFist ? 0.012 : 0.0015) - rotationSpeed) * 0.05;
    treeParticles.rotation.y += rotationSpeed;
    renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
